
<!DOCTYPE html>
<html>
<head>
    <title>Wind</title>
    <script src="chart.js"></script>
</head>
<body>
    <h1 id="windText">Current Wind: Null</h1>
    <canvas id="realtimeChart" width="400" height="400"></canvas>
    <canvas id="longtermChart" width="400" height="400"></canvas>
    <script>
        var wind_text = document.getElementById('windText');
        var ctx = document.getElementById('realtimeChart').getContext('2d');
        var realtimeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [], // Start with empty labels
                datasets: [{
                    label: 'Real-time Wind',
                    data: [], // Start with empty data
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                animation: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
 
        function update_charts() {
            // Replace 'https://example.com/data' with your actual data endpoint
            //fetch('wind/data_since?duration=600.0')
            fetch('wind/last_data')
                .then(response => response.json())
                .then(data => {
                    // Assuming 'data' is an object that has a 'value' property
                    const newValue = data.vel.toFixed(1);
                    wind_text.innerText = `Current Wind: ${newValue} m/s`;
                    const newLabel = new Date(Math.floor(data.ts* 1000)).toLocaleTimeString();
                    console.log("data", data.ts, Math.floor(data.ts* 1000), newLabel);

                    // Update chart data and labels
                    realtimeChart.data.labels.push(newLabel);
                    realtimeChart.data.datasets.forEach((dataset) => {
                        dataset.data.push(newValue);
                    });

                    // Remove the first label and data point if more than 20 items to avoid squeezing the chart
                    if (realtimeChart.data.labels.length > 10) {
                        realtimeChart.data.labels.shift();
                        realtimeChart.data.datasets.forEach((dataset) => {
                            dataset.data.shift();
                        });
                    }

                    realtimeChart.update();
                    console.log("update done");
                })
                .catch(error => console.error('Error fetching data:', error));

            setTimeout(update_charts, 1000);
        }


        function fill_then_update_charts() {
            fetch('wind/data_since?duration=600.0&interval=60.0')
                .then(response => response.json())
                .then(datalist => {
                    datalist.forEach((data) => {

                        // Assuming 'data' is an object that has a 'value' property
                        const newValue = data.vel.toFixed(1);
                        const newLabel = new Date(Math.floor(data.ts* 1000)).toLocaleTimeString();
    
                        // Update chart data and labels
                        realtimeChart.data.labels.push(newLabel);
                        realtimeChart.data.datasets.forEach((dataset) => {
                            dataset.data.push(newValue);
                        });


                    });
                })
                .catch(error => console.error('Error fetching data:', error));
            realtimeChart.update();
            setTimeout(update_charts, 1000);
        }

        fill_then_update_charts();

    </script>
</body>
</html>

